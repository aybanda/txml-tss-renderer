<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSX ImGui Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: white;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        .left, .right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        textarea {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            color: white;
            resize: vertical;
            min-height: 150px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success { background: #2d5a2d; color: #90ee90; }
        .status.error { background: #5a2d2d; color: #ff6b6b; }
        .status.info { background: #2d4a5a; color: #87ceeb; }
        canvas {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            width: 100%;
            height: 100%;
        }
        .console {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            color: white;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>JSX ImGui Demo</h1>
    <div class="container">
        <div class="left">
            <h3>JSX Code:</h3>
            <textarea id="jsxEditor">function App() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('');
  const [volume, setVolume] = useState(0.5);
  const [enabled, setEnabled] = useState(false);

  return (
    <App>
      <Body>
        <Window title="JSX ImGui Demo">
          <Text>Welcome to JSX ImGui!</Text>
          <Text>Count: {count}</Text>
          <Button onClick={() => setCount(count + 1)}>
            Clicked {count} times
          </Button>
          <SameLine />
          <Checkbox 
            label="Enable Feature" 
            checked={enabled}
            onChange={setEnabled}
          />
          <InputText 
            label="Name" 
            hint="Enter your name"
            value={name}
            onChange={setName}
          />
          <SliderFloat 
            label="Volume" 
            min={0} 
            max={1}
            value={volume}
            onChange={setVolume}
          />
        </Window>
      </Body>
    </App>
  );
}</textarea>
            
            <h3>TSS Styles:</h3>
            <textarea id="tssEditor">:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --text-color: #ffffff;
  --accent-color: #FF9800;
}

Window {
  color: var(--text-color);
}

Button {
  background-color: var(--primary-color);
  color: white;
}

Text {
  color: var(--text-color);
}

Checkbox {
  color: var(--accent-color);
}</textarea>
            

            
            <div>
                <button id="renderBtn">Render JSX to ImGui</button>
                <button id="resetBtn">Reset</button>
                <div id="status" class="status info">Ready to render</div>
            </div>
        </div>
        
        <div class="right">
            <h3>ImGui Canvas:</h3>
            <canvas id="canvas" width="600" height="400"></canvas>
            
            <h3>Console Output:</h3>
            <div id="consoleOutput" class="console">Console output will appear here...</div>
        </div>
    </div>

    <script type="module">
        let ImGui = null;
        let ImGuiImplWeb = null;
        let isRendering = false;
        let animationId = null;
        let context = null;
        
        // State for JSX demo
        const state = { count: 0 };
        let renderer = null;
        
        // Console output
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        console.log = (...args) => {
            originalLog(...args);
            consoleOutput.textContent += args.join(' ') + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // Load TXML/TSS renderer for JSX demo
        async function loadRenderer() {
            try {
                const { TXMLTSSRenderer, jsx } = await import('../dist/index.js');
                renderer = new TXMLTSSRenderer();
                
                // Register event handlers
                renderer.registerEventHandler('incrementCount', () => {
                    state.count++;
                    console.log('Count incremented via JSX:', state.count);
                    document.getElementById('status').textContent = `Count: ${state.count}`;
                    document.getElementById('status').className = 'status success';
                });
                
                renderer.registerEventHandler('resetCount', () => {
                    state.count = 0;
                    console.log('Count reset via JSX');
                });
                
                console.log('JSX renderer loaded successfully');
                return true;
            } catch (error) {
                console.error('Failed to load JSX renderer:', error);
                return false;
            }
        }
        
        // Convert JSX to TXML
        function jsxToTXML(jsxCode) {
            // Simple JSX to TXML conversion for demo
            const txml = `<App>
  <Body>
    <Window title="JSX ImGui Demo">
      <Text>JSX rendered to ImGui</Text>
      <Text>Count: ${state.count}</Text>
      <Button onClick="incrementCount">Increment</Button>
      <SameLine />
      <Button onClick="resetCount">Reset</Button>
    </Window>
  </Body>
</App>`;
            return txml;
        }
        
        // ImGui demo using the exact working pattern
        async function initImGui() {
            try {
                console.log('Loading jsimgui...');
                const jsimgui = await import('https://esm.sh/@mori2003/jsimgui');
                ImGui = jsimgui.ImGui;
                ImGuiImplWeb = jsimgui.ImGuiImplWeb;
                console.log('jsimgui loaded successfully');
                
                const canvas = document.getElementById('canvas');
                console.log('Canvas element:', canvas);
                
                // Set canvas dimensions
                canvas.width = 600;
                canvas.height = 400;
                console.log('Canvas dimensions set to:', canvas.width, 'x', canvas.height);
                
                // Get WebGL context
                context = canvas.getContext("webgl2");
                if (!context) {
                    throw new Error('WebGL2 not supported');
                }
                console.log('WebGL2 context created');
                
                // Initialize ImGui using the exact working pattern
                console.log('Initializing ImGui...');
                await ImGuiImplWeb.Init({
                    canvas,
                    enableDemos: true,
                });
                console.log('ImGuiImplWeb.Init() completed');
                
                // Wait for initialization
                await new Promise(resolve => setTimeout(resolve, 1000));
                console.log('ImGui initialization wait completed');
                
                // Load JSX renderer
                await loadRenderer();
                
                // Set up render loop using the exact working pattern
                function frame() {
                    if (!isRendering) return;
                    
                    try {
                        ImGuiImplWeb.BeginRender();
                        
                        // Render JSX content using direct ImGui calls
                        try {
                            const jsxCode = document.getElementById('jsxEditor').value;
                            const tss = document.getElementById('tssEditor').value;
                            
                            console.log('Converting JSX to TXML...');
                            const txml = jsxToTXML(jsxCode);
                            console.log('Generated TXML:', txml);
                            
                            // Generate and log ImGui code
                            const generatedCode = `// Generated ImGui code from JSX:
ImGui.Begin("JSX ImGui Demo");
ImGui.Text("JSX rendered to ImGui");
ImGui.Text("Count: ${state.count}");
if (ImGui.Button("Increment")) {
    // incrementCount() called
}
ImGui.SameLine();
if (ImGui.Button("Reset")) {
    // resetCount() called
}
ImGui.End();`;
                            console.log('Generated ImGui code:', generatedCode);
                            
                            // Render JSX content directly to ImGui
                            ImGui.Begin("JSX ImGui Demo");
                            ImGui.Text("JSX rendered to ImGui");
                            ImGui.Text(`Count: ${state.count}`);
                            
                            if (ImGui.Button("Increment")) {
                                state.count++;
                                console.log('Count incremented via JSX:', state.count);
                                document.getElementById('status').textContent = `Count: ${state.count}`;
                                document.getElementById('status').className = 'status success';
                            }
                            
                            ImGui.SameLine();
                            if (ImGui.Button("Reset")) {
                                state.count = 0;
                                console.log('Count reset via JSX');
                            }
                            
                            ImGui.End();
                            
                        } catch (error) {
                            console.error('JSX render error:', error);
                            // Fallback to simple demo
                            ImGui.Begin("JSX ImGui Demo (Error)");
                            ImGui.Text("JSX renderer error");
                            ImGui.Text(`Error: ${error.message}`);
                            ImGui.End();
                        }
                        
                        // Show the ImGui demo window
                        ImGui.ShowDemoWindow();
                        
                        // Clear the canvas
                        context.clearColor(0.1, 0.3, 0.1, 1.0);
                        context.clear(context.COLOR_BUFFER_BIT);
                        
                        ImGuiImplWeb.EndRender();
                        
                        console.log('JSX ImGui rendered successfully');
                    } catch (error) {
                        console.error('Render loop error:', error.message);
                        isRendering = false;
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                            animationId = null;
                        }
                    }
                    
                    if (isRendering) {
                        animationId = requestAnimationFrame(frame);
                    }
                }
                
                // Start render loop
                isRendering = true;
                frame();
                
                console.log('JSX ImGui initialized successfully');
                return true;
                
            } catch (error) {
                console.error('ImGui initialization failed:', error);
                isRendering = false;
                throw error;
            }
        }
        
        // Event listeners
        document.getElementById('renderBtn').addEventListener('click', async () => {
            try {
                document.getElementById('status').textContent = 'Initializing...';
                document.getElementById('status').className = 'status info';
                
                if (!isRendering) {
                    await initImGui();
                }
                
                document.getElementById('status').textContent = 'Rendering JSX...';
                document.getElementById('status').className = 'status success';
                
            } catch (error) {
                console.error('Render failed:', error);
                document.getElementById('status').textContent = 'Render failed';
                document.getElementById('status').className = 'status error';
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            isRendering = false;
            ImGui = null;
            ImGuiImplWeb = null;
            context = null;
            
            // Reset state
            state.count = 0;
            
            // Clear canvas
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Clear console
            consoleOutput.textContent = 'Console output will appear here...';
            
            document.getElementById('status').textContent = 'Reset complete';
            document.getElementById('status').className = 'status info';
            
            console.log('Reset complete');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('JSX ImGui Demo loaded');
        });
    </script>
</body>
</html>
