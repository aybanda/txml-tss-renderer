<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build-time JSX ImGui Demo v2.0</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: white;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        .left, .right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success { background: #2d5a2d; color: #90ee90; }
        .status.error { background: #5a2d2d; color: #ff6b6b; }
        .status.info { background: #2d4a5a; color: #87ceeb; }
        canvas {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            width: 100%;
            height: 100%;
        }
        .console {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            color: white;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .info-panel {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Build-time JSX ImGui Demo</h1>
    <div class="container">
        <div class="left">
            <div class="info-panel">
                <h3>Build-time JSX Compilation</h3>
                <p>This demo shows JSX compiled at build time (not runtime Babel).</p>
                <p>The JSX is pre-compiled to TXML during the build process.</p>
                <p>No runtime Babel dependency - production ready!</p>
                <p><strong>Note:</strong> WebGPU has compatibility issues with jsimgui library. Use WebGL2 for now.</p>
            </div>
            
            <div>
                <label for="backendSelect">Backend:</label>
                <select id="backendSelect">
                    <option value="webgl2" selected>WebGL2 (Working)</option>
                    <option value="webgpu">WebGPU (Broken - jsimgui issue)</option>
                </select>
                <button id="renderBtn">Render Build-time JSX</button>
                <button id="resetBtn">Reset</button>
                <div id="status" class="status info">Ready to render</div>
            </div>
        </div>
        
        <div class="right">
            <h3>ImGui Canvas:</h3>
            <canvas id="canvas" width="600" height="400"></canvas>
            
            <h3>Console Output:</h3>
            <div id="consoleOutput" class="console">Console output will appear here...</div>
        </div>
    </div>

    <script type="module">
        let ImGui = null;
        let ImGuiImplWeb = null;
        let ImGuiImplWGPU = null;
        let isRendering = false;
        let animationId = null;
        let context = null;
        let isInited = false;
        let frameCount = 0;
        let backend = 'webgl2';
        let buildTimeTXML = null;
        let buildTimeTSS = null;
        let renderer = null;
        
        // Console output
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        console.log = (...args) => {
            originalLog(...args);
            consoleOutput.textContent += args.join(' ') + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // Load build-time compiled JSX demo
        async function loadBuildTimeDemo() {
            try {
                const { initJSXDemo } = await import('./jsx-demo.jsx');
                console.log('Build-time JSX demo loaded successfully');
                return initJSXDemo;
            } catch (error) {
                console.error('Failed to load build-time JSX demo:', error);
                console.error('Error details:', error.message);
                return null;
            }
        }
        
        // ImGui initialization
        async function initImGui() {
            try {
                if (isInited) {
                    console.log('ImGui already initialized; skipping re-init');
                    isRendering = true;
                    return true;
                }
                
                console.log('Loading jsimgui...');
                const jsimgui = await import('https://esm.sh/@mori2003/jsimgui');
                ImGui = jsimgui.ImGui;
                ImGuiImplWeb = jsimgui.ImGuiImplWeb;
                ImGuiImplWGPU = jsimgui.ImGuiImplWGPU;
                console.log('jsimgui loaded successfully');
                console.log('Available ImGui modules:', Object.keys(jsimgui));
                console.log('ImGuiImplWGPU available:', typeof ImGuiImplWGPU);
                
                const canvas = document.getElementById('canvas');
                console.log('Canvas element:', canvas);
                
                // Set canvas dimensions
                canvas.width = 600;
                canvas.height = 400;
                console.log('Canvas dimensions set to:', canvas.width, 'x', canvas.height);
                
                // Get selected backend
                const backendEl = document.getElementById('backendSelect');
                backend = backendEl && 'value' in backendEl ? backendEl.value : 'webgl2';
                
                let device = null;
                
                if (backend === 'webgpu') {
                    // Check WebGPU support
                    if (!navigator.gpu) {
                        throw new Error('WebGPU not supported in this browser');
                    }
                    
                    // Get WebGPU context
                    context = canvas.getContext('webgpu');
                    if (!context) {
                        throw new Error('WebGPU context not supported');
                    }
                    
                    // Request WebGPU adapter and device
                    const adapter = await navigator.gpu.requestAdapter({
                        powerPreference: 'high-performance'
                    });
                    if (!adapter) {
                        throw new Error('WebGPU adapter not available');
                    }
                    
                    device = await adapter.requestDevice({
                        requiredFeatures: [],
                        requiredLimits: {}
                    });
                    
                    // Configure WebGPU context
                    const preferredFormat = navigator.gpu.getPreferredCanvasFormat();
                    context.configure({
                        device,
                        format: preferredFormat,
                        usage: GPUTextureUsage.RENDER_ATTACHMENT,
                        alphaMode: 'premultiplied'
                    });
                    
                    // Store device globally for use in render loop
                    window.webgpuDevice = device;
                    
                    console.log('WebGPU context created and configured');
                    console.log('WebGPU device:', device);
                    console.log('WebGPU context:', context);
                    console.log('WebGPU preferred format:', preferredFormat);
                    
                    // Wait for WebGPU device to be fully ready
                    await new Promise(resolve => setTimeout(resolve, 100));
                } else {
                    // WebGL2 backend
                    context = canvas.getContext('webgl2');
                    if (!context) {
                        throw new Error('WebGL2 not supported');
                    }
                    console.log('WebGL2 context created');
                }
                
                // Initialize ImGui with proper backend configuration
                console.log('Initializing ImGui...');
                if (backend === 'webgpu') {
                    console.log('WebGPU: Initializing ImGui with WebGPU backend...');
                    try {
                        // Initialize ImGui with WebGPU backend
                        console.log('WebGPU: Initializing with ImGuiImplWeb.Init');
                        await ImGuiImplWeb.Init({
                            canvas,
                            device,
                            backend: 'webgpu'
                        });
                        
                        // Try additional WebGPU-specific initialization if available
                        if (ImGuiImplWGPU && ImGuiImplWGPU.Init) {
                            console.log('WebGPU: Additional setup with ImGuiImplWGPU.Init');
                            try {
                                await ImGuiImplWGPU.Init({
                                    canvas: canvas,
                                    device: device
                                });
                                console.log('WebGPU: ImGuiImplWGPU.Init completed');
                            } catch (wgpuError) {
                                console.warn('WebGPU: ImGuiImplWGPU.Init failed, continuing with ImGuiImplWeb:', wgpuError.message);
                            }
                        } else {
                            console.log('WebGPU: ImGuiImplWGPU not available, using ImGuiImplWeb only');
                        }
                        
                        console.log('WebGPU: ImGui initialization completed');
                    } catch (error) {
                        console.error('WebGPU: ImGui initialization failed:', error);
                        throw error;
                    }
                } else {
                    console.log('WebGL2: Initializing ImGui with WebGL2 backend...');
                    await ImGuiImplWeb.Init({
                        canvas,
                        context,
                        enableDemos: true,
                        backend: 'webgl2'
                    });
                    console.log('WebGL2: ImGui initialization completed');
                }
                console.log('ImGuiImplWeb.Init() completed');
                
                // Wait for ImGui to be properly initialized
                console.log('Waiting for ImGui to be fully initialized...');
                await new Promise(resolve => setTimeout(resolve, 500));
                console.log('ImGui initialization wait completed');
                
                // Load build-time JSX demo
                console.log('Loading build-time JSX demo...');
                const initDemo = await loadBuildTimeDemo();
                if (initDemo) {
                    console.log('Calling initJSXDemo...');
                    const { txml, tssStyles } = await initDemo();
                    buildTimeTXML = txml;
                    buildTimeTSS = tssStyles;
                    console.log('Build-time JSX TXML:', txml);
                    console.log('Build-time JSX TSS:', tssStyles);
                    console.log('Build-time content loaded successfully!');
                } else {
                    console.error('Failed to load build-time JSX demo');
                }
                
                // Create renderer once outside the render loop
                console.log('Checking if renderer should be created...');
                console.log('buildTimeTXML exists:', !!buildTimeTXML);
                console.log('buildTimeTSS exists:', !!buildTimeTSS);
                console.log('buildTimeTXML value:', buildTimeTXML);
                console.log('buildTimeTSS value:', buildTimeTSS);
                
                if (buildTimeTXML && buildTimeTSS) {
                    console.log('Creating TXML/TSS renderer...');
                    const { TXMLTSSRenderer, DefaultConsoleLogger } = await import('../dist/index.js');
                    const logger = new DefaultConsoleLogger();
                    renderer = new TXMLTSSRenderer(logger);
                    
                    // Set the ImGui instance - this is the key fix!
                    console.log('Setting ImGui instance on renderer...');
                    console.log('ImGui available:', typeof ImGui);
                    console.log('ImGuiImplWeb available:', typeof ImGuiImplWeb);
                    renderer.setImGui(ImGui, ImGuiImplWeb);
                    console.log('ImGui instance set on renderer');
                    
                    // Register event handlers
                    renderer.registerEventHandler('incrementCount', () => {
                        console.log('Count incremented via build-time JSX!');
                    });
                    
                    renderer.registerEventHandler('greenClick', () => {
                        console.log('Green button clicked! Build-time JSX working!');
                    });
                    
                    console.log('TXML/TSS renderer created and configured');
                } else {
                    console.log('Renderer NOT created - missing buildTimeTXML or buildTimeTSS');
                }
                
                // Set up render loop
                async function frame() {
                    if (!isRendering) return;
                    
                    try {
                        // Use proper ImGui frame management sequence
                        ImGuiImplWeb.BeginRender();
                        
                        // DEBUG: Check frame state
                        frameCount++;
                        console.log(`Frame ${frameCount}: Starting render with proper frame management`);
                        
                        // Render the build-time JSX content
                        if (renderer && buildTimeTXML && buildTimeTSS) {
                            try {
                                console.log('Rendering build-time JSX content...');
                                console.log('Renderer imgui:', renderer.imgui);
                                console.log('Renderer imguiImplWeb:', renderer.imguiImplWeb);
                                console.log('TXML to render:', buildTimeTXML);
                                console.log('TSS to render:', buildTimeTSS);
                                renderer.render(buildTimeTXML, buildTimeTSS);
                                console.log('Build-time JSX rendered successfully');
                            } catch (error) {
                                console.error('Error rendering build-time JSX:', error);
                                console.error('Error stack:', error.stack);
                                console.error('TXML that failed:', buildTimeTXML);
                                console.error('TSS that failed:', buildTimeTSS);
                                // Fallback to default demo if custom rendering fails
                                ImGui.ShowDemoWindow();
                            }
                        } else {
                            console.log('No renderer or content available, showing default demo');
                            ImGui.ShowDemoWindow();
                        }
                        
                        // Clear the canvas if we are webgl; webgpu handles this for us
                        if (backend === 'webgl2') {
                            context.clearColor(0.1, 0.3, 0.1, 1.0);
                            context.clear(context.COLOR_BUFFER_BIT);
                        }
                        
                        // Use proper ImGui render sequence
                        if (backend === 'webgpu') {
                            // For WebGPU, try the simplest approach first
                            try {
                                // Render ImGui draw data
                                ImGui.Render();
                                
                                // Try the standard EndRender method first
                                ImGuiImplWeb.EndRender();
                                console.log('WebGPU: Used standard ImGuiImplWeb.EndRender');
                                
                            } catch (webgpuError) {
                                console.warn('WebGPU standard EndRender failed:', webgpuError.message);
                                
                                // If standard fails, try with command encoder
                                try {
                                    const commandEncoder = window.webgpuDevice.createCommandEncoder();
                                    ImGuiImplWeb.EndRender(commandEncoder);
                                    const commandBuffer = commandEncoder.finish();
                                    window.webgpuDevice.queue.submit([commandBuffer]);
                                    console.log('WebGPU: Used EndRender with command encoder');
                                } catch (encoderError) {
                                    console.warn('WebGPU command encoder failed:', encoderError.message);
                                    
                                    // Last resort: try manual WebGPU rendering
                                    try {
                                        const commandEncoder = window.webgpuDevice.createCommandEncoder();
                                        const textureView = context.getCurrentTexture().createView();
                                        
                                        const renderPassDescriptor = {
                                            colorAttachments: [{
                                                view: textureView,
                                                clearValue: { r: 0.1, g: 0.3, b: 0.1, a: 1.0 },
                                                loadOp: 'clear',
                                                storeOp: 'store',
                                            }],
                                        };
                                        
                                        const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);
                                        
                                        // Try to render ImGui draw data
                                        const drawData = ImGui.GetDrawData();
                                        if (ImGuiImplWGPU && ImGuiImplWGPU.RenderDrawData) {
                                            ImGuiImplWGPU.RenderDrawData(drawData, window.webgpuDevice, passEncoder);
                                        }
                                        
                                        passEncoder.end();
                                        const commandBuffer = commandEncoder.finish();
                                        window.webgpuDevice.queue.submit([commandBuffer]);
                                        console.log('WebGPU: Used manual WebGPU rendering');
                                    } catch (manualError) {
                                        console.warn('WebGPU manual rendering failed:', manualError.message);
                                    }
                                }
                            }
                        } else {
                            // For WebGL2, use the standard EndRender
                            try {
                                ImGuiImplWeb.EndRender();
                                console.log('ImGui EndRender completed');
                            } catch (renderError) {
                                console.warn('Render error (non-critical):', renderError.message);
                            }
                        }
                        
                        console.log('Build-time JSX ImGui rendered successfully');
                    } catch (error) {
                        console.error('Render loop error:', error.message);
                        isRendering = false;
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                            animationId = null;
                        }
                    }
                    
                    if (isRendering) {
                        animationId = requestAnimationFrame(frame);
                    }
                }
                
                // Start render loop
                isRendering = true;
                frame();
                
                console.log('Build-time JSX ImGui initialized successfully');
                isInited = true;
                return true;
                
            } catch (error) {
                console.error('ImGui initialization failed:', error);
                isRendering = false;
                throw error;
            }
        }
        
        function teardownImGui() {
            try {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                isRendering = false;
                try { ImGuiImplWeb && ImGuiImplWeb.Shutdown && ImGuiImplWeb.Shutdown(); } catch {}
                try { ImGui && ImGui.DestroyContext && ImGui.DestroyContext(); } catch {}
            } finally {
                isInited = false;
                ImGui = null;
                ImGuiImplWeb = null;
                context = null;
                renderer = null;
            }
        }
        
        // Event listeners
        document.getElementById('renderBtn').addEventListener('click', async () => {
            try {
                document.getElementById('status').textContent = 'Initializing...';
                document.getElementById('status').className = 'status info';
                
                await initImGui();
                
                document.getElementById('status').textContent = 'Rendering build-time JSX...';
                document.getElementById('status').className = 'status success';
                
            } catch (error) {
                console.error('Render failed:', error);
                document.getElementById('status').textContent = 'Render failed';
                document.getElementById('status').className = 'status error';
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            teardownImGui();
            
            // Clear console
            consoleOutput.textContent = 'Console output will appear here...';
            
            document.getElementById('status').textContent = 'Reset complete';
            document.getElementById('status').className = 'status info';
            
            console.log('Reset complete');
        });
        
        // Reinitialize on backend change (requires teardown)
        document.getElementById('backendSelect').addEventListener('change', async () => {
            try {
                document.getElementById('status').textContent = 'Switching backend...';
                document.getElementById('status').className = 'status info';
                teardownImGui();
                await initImGui();
                document.getElementById('status').textContent = 'Backend switched';
                document.getElementById('status').className = 'status success';
            } catch (e) {
                document.getElementById('status').textContent = 'Backend switch failed';
                document.getElementById('status').className = 'status error';
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Build-time JSX ImGui Demo loaded');
        });
    </script>
</body>
</html>
